1  REM  COPYRIGHT 2013 ADAM GREEN (HTTP://GITHUB.COM/ADAMGREEN)
2  REM  LICENSED UNDER THE APACHE LICENSE, VERSION 2.0
3  REM  SEE APACHE.BAS FOR LICENSE INFO.
4  REM 
5  REM  SIMPLE 6502 SYMBOLIC ASSEMBLER
1000  DATA  "ADC",105,109,101,255,97,113,117,255,125,121,255,255,255,114
1099  DATA  ""
1200  DATA  "ASC","DB","DS","DW","EQU","LST","SAV","TST"
1299  DATA  ""
1300  DATA  "LABEL ADC #$20 ;COMMENT"
1301  DATA  " END"
2000  CLEAR : GOSUB 2100: GOSUB 2800: PRINT "ASSEMBLY STARTED":P% = 1: GOSUB 2900: GOSUB 31000:P% = 2: GOSUB 31000: GOSUB 31000: GOSUB 31000
2010  REM  UNDONE: REMOVE NEXT LINE AND MOVE END UP INTO PREV LINE
2020  HIMEM: 38400: END 
2100  SPEED= 255: TEXT : PRINT : PRINT  CHR$(4);"PR#3": HOME : GOSUB 2200: GOSUB 2300: GOSUB 2400: GOSUB 2600: RETURN 
2200  IF  PEEK(116) *256 + PEEK(115) < >38400  THEN  PRINT "*HIMEM": STOP 
2210  IF  PEEK(110) *256 + PEEK(109) > = 30208  THEN  PRINT "*NORAM": STOP 
2220  HIMEM: 30208: RETURN 
2300 LF% = 1:TF% = 0:IC% = 0:DC% = 0:SC% = 0:TW% = 768:TR% = 768:TC% = 0
2310 D$ =  CHR$(4)
2320  DIM O%(13): DIM SN$(255): DIM SV%(255)
2330  RETURN 
2400  READ T$: IF T$ = ""  THEN 2420
2410 IC% = IC% +1: GOSUB 2500: GOTO 2400
2420  READ T$: IF T$ = ""  THEN  RETURN 
2430 DC% = DC% +1: GOTO 2420
2500  FOR I = 1 TO 14: READ T$: NEXT : RETURN 
2600  GOSUB 2700:S1% = D1%:S2% = D2%:S3% = D3%:S4% = D4%: RETURN 
2700 D1% =  PEEK(123):D2% =  PEEK(124):D3% =  PEEK(125):D4% =  PEEK(126): RETURN 
2800  RETURN 
2900 P = 30208
2910  GOSUB 3000: GOSUB 3700: IF O$ = "END"  THEN  RETURN 
2915  PRINT L$: PRINT O$: PRINT P$: PRINT C$
2920  GOTO 2910
3000  GOSUB 3100: GOSUB 3200: READ A$: GOSUB 2700:A% =  LEN(A$):A = P:E = 65536:I = 1: GOSUB 3300: IF R%  THEN  RETURN 
3010 L$ = T$: GOSUB 3300: IF R%  THEN  RETURN 
3020 O$ = T$: GOSUB 3300: IF R%  THEN  RETURN 
3030 P$ = T$: GOSUB 3300: IF   NOT R%  THEN  GOSUB 3600: PRINT "EXTRA_INPUT"
3040  RETURN 
3100 T$ = "":A$ = "":L$ = "":O$ = "":P$ = "":C$ = "":S$ = "":E$ = ""
3110  PRINT D$;"FRE(0)": RETURN 
3200  POKE 123,D1%: POKE 124,D2%: POKE 125,D3%: POKE 126,D4%: RETURN 
3300  IF I = A% +1  THEN R% = 1: RETURN 
3310  IF  MID$ (A$,I,1) = ";"  THEN C$ =  MID$ (A$,I):R% = 1: RETURN 
3320  GOSUB 3400:T$ =  MID$ (A$,I,K -I):I = K: GOSUB 3500:I = K:R% = 0: RETURN 
3400 K = I
3410  IF K >A%  THEN  RETURN 
3420  IF  MID$ (A$,K,1) = " "  THEN  RETURN 
3430 K = K +1: GOTO 3410
3500 K = I
3510  IF K >A%  THEN  RETURN 
3520  IF  MID$ (A$,K,1) < >" "  THEN  RETURN 
3530 K = K +1: GOTO 3510
3600  PRINT "LINE:";D2% *256 +D1%;" *";: RETURN 
3700  IF TF%  THEN  GOSUB 3800
3710  GOSUB 4300:F% = 0: GOSUB 4600: GOSUB 31000: IF   NOT F%  AND O$ < >"END"  THEN  GOSUB 3600: PRINT "INVALID_OPCODE"
3720  IF LF%  THEN  GOSUB 31000
3730  RETURN 
3800  GOSUB 3900: IF   NOT R%  THEN  RETURN 
3810  GOSUB 4000: RETURN 
3900  IF C$ = ""  THEN  RETURN 
3910  FOR I = 1 TO  LEN(C$):T$ =  MID$ (C$,I,1): IF T$ < >" "  AND T$ <"0"  AND T$ >"9"  AND T$ <"A"  AND T$ >"F"  THEN R% = 0: RETURN 
4000 I = 1
4010  IF I > =  LEN(C$)  THEN  RETURN 
4020  GOSUB 4100:E$ =  MID$ (C$,I,2): GOSUB 30000: GOSUB 4200:I = I +2: GOTO 4020
4100  IF I > =  LEN(C$)  THEN  RETURN 
4110  IF  MID$ (C$,I,1) < >" "  THEN  RETURN 
4120 I = I +1: GOTO 4100
4200  IF TC% = 256  THEN  GOSUB 3600: PRINT "TST_OVER": STOP 
4210  POKE TW%,E%:TW% = TW% +1: IF TW% >1023  THEN TW% = 768
4220 TC% = TC% +1: RETURN 
4300  IF L$ = ""  OR P% = 2  THEN  RETURN 
4310 LI% =  -1:S$ = L$: GOSUB 4400: IF SI% < > -1  THEN  GOSUB 3600: PRINT "DUP_LABEL": RETURN 
4320  GOSUB 4500: IF SI% =  -1  THEN  GOSUB 3600: PRINT "TOO_MANY_LABELS": STOP 
4330 LI% = SI%:SN$(LI%) = L$:SV%(LI%) = P: RETURN 
4400  IF SC% = 0  THEN SI% =  -1: RETURN 
4410  FOR K = 0 TO SC% -1  STEP 1: IF SN$(K) = S$  THEN SI% = K: RETURN 
4420 SI% =  -1: RETURN 
4500  IF SC% = 256  THEN SI% =  -1: RETURN 
4510 SI% = SC%:SC% = SC% +1: RETURN 
4600  IF O$ = ""  THEN F% = 1: RETURN 
4610  GOSUB 4700: IF   NOT F%  THEN  RETURN 
4620  GOSUB 4900: RETURN 
4700  RESTORE : FOR I = 1 TO IC%: READ T$: IF T$ = O$  THEN F% = 1: GOSUB 4800: RETURN 
4710  GOSUB 2500: NEXT : RETURN 
4800  FOR K = 0 TO 13: READ O%(K): NEXT K: RETURN 
4900 L% =  LEN(P$): GOSUB 5000: IF P$ = ""  THEN  GOSUB 5100: RETURN 
4910  IF  MID$ (P$,1,1) = "#"  THEN  GOSUB 5700: RETURN 
4920  GOSUB 31000: IF R%  THEN  GOSUB 31000: RETURN 
4930  GOSUB 31000: IF R%  THEN  GOSUB 31000: RETURN 
4940  GOSUB 31000: IF R%  THEN  GOSUB 31000: RETURN 
4950  GOSUB 31000: IF R%  THEN  GOSUB 31000: RETURN 
4960  GOSUB 31000: IF R%  THEN  GOSUB 31000: RETURN 
4970  GOSUB 31000: RETURN 
5000 OP% =  -1:CP% =  -1:CM% =  -1: IF L% = 0  THEN  RETURN 
5010  FOR I = 1 TO L%:T$ =  MID$ (P$,I,1): IF T$ = "("  THEN OP% = I
5020  IF T$ = ")"  THEN CP% = I
5030  IF T$ = ","  THEN CM% = I
5040  NEXT : RETURN 
5100  IF O%(3) = 255  THEN  GOSUB 5200: RETURN 
5110 X% = O%(3): GOSUB 5300: RETURN 
5200  GOSUB 3600: PRINT "BAD_ADDR": RETURN 
5300  IF P% = 2  AND X < > PEEK(P)  THEN  GOSUB 3600: PRINT "PHASE": STOP 
5310  GOSUB 5400: RETURN 
5400  IF P > = 38400  THEN  GOSUB 3600: PRINT "OOM": STOP 
5410  POKE P,X%:P = P +1: IF TF%  THEN  GOSUB 5500
5420  RETURN 
5500  GOSUB 5600: IF T% < >X%  THEN  GOSUB 3600: PRINT "TST_FAIL": STOP 
5510  RETURN 
5600  IF TC% = 0  THEN  GOSUB 3600: PRINT "TST_UNDER": STOP 
5610 T% =  PEEK(TR%):TR% = TR% +1: IF TR% >1023  THEN TR% = 768
5620 TC% = TC% -1: RETURN 
5700  IF 2 >L%  THEN  GOSUB 5800: RETURN 
5710 T$ =  MID$ (P$,2,1): IF T$ = "<"  THEN E$ =  MID$ (P$,3): GOSUB 5900:E% = E% -(E%/256) *256: GOTO 5740
5720  IF T$ = ">"  THEN E$ =  MID$ (P$,3): GOSUB 5900:E% = E%/256: GOTO 5740
5730 E$ =  MID$ (P$,2): GOSUB 5900
5740  IF O%(0) = 255  THEN  GOSUB 5200: RETURN 
5750 X% = O%(0): GOSUB 5300: IF E% >255  THEN  GOSUB 3600: PRINT "TOO_BIG": RETURN 
5760 X% = E%: GOSUB 5400: RETURN 
5800  GOSUB 3600: PRINT "BAD_EXPR": RETURN 
5900  IF E$ = ""  THEN  GOSUB 5800: RETURN 
5910 L% =  LEN(E$):T$ =  MID$ (E$,1,1): IF T$ = "$"  THEN  GOSUB 6000: RETURN 
5920  IF T$ > = "0"  AND T$ < = "9"  THEN  GOSUB 6100: RETURN 
5930  GOSUB 6200: RETURN 
6000  IF L% <2  THEN  GOSUB 5800: RETURN 
6010 E% = 0: FOR I = 2 TO L%:T% =  ASC( MID$ (E$,I,1)): IF T% > = 48  AND T% < = 57  THEN T% = T% -48: GOTO 6040
6020  IF T% > = 65  AND T% < = 70  THEN T% = T% -55: GOTO 6040
6030 E% =  -1: GOSUB 3600: PRINT "BAD_HEX": RETURN 
6040 E% = E% *16 +T%: NEXT : RETURN 
6100 E% =  VAL( MID$ (E$,1)): RETURN 
6200 S$ =  MID$ (E$,1): GOSUB 4400: IF SI% < > -1  THEN E% = SV%(SI%): RETURN 
6210  IF P% = 1  THEN E% = 256: RETURN 
6220 E% =  -1: GOSUB 3600: PRINT "BAD_LABEL": RETURN 
30000  STOP 
31000  RETURN 